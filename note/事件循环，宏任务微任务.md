# 什么是事件循环event loop

在了解事件循环之前，需要了解一些JS前置知识。

JS引擎是单线程的，直白的说一个时间点JS引擎只能去做一件事情，而Java这种多线程语言，可以同时做几件事情。

JS做的任务分为同步和异步，所谓'异步'，简单地说就是一个任务不是连续完成的，先执行第一段，等做好了准备再回过头来执行第二段，第二段也叫做回调；同步则是连贯完成的。

像读取文件，网络请求这些都属于异步任务；花费时间很长(夸张)，但中间操作不需要JS自己完成，等别人准备好了，获取到数据了，在执行回调部分。

如果没有特殊处理，JS引擎在执行异步任务时，应该是存在等待的，不去做任何其他事情，会浪费很多的空闲时间![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c5fa00af07f24540874617cb36ff7a6a~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

所以采取了以下的“异步任务回调通知”模式![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/68108488bd8341d7bda294be0380bd9d~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

即等待数据返回的同时，限制性其他同步任务，数据准备好了，在进行回调。也叫做非阻塞模式，通过事件循环来实现。

事件循环就是，当这个进程开始了之后，程序中会有一个任务队列，js会按顺序的一个一个执行，为了避免异步任务阻塞后面的任务，当遇到异步任务时，不会立即执行，而是把它放到异步任务的队伍中，等同步任务执行完成之后再去看有没有可执行的异步任务，如果有就拿到主进程中执行。

# 宏任务和微任务

当我们了解过了event loop之后，就会明白event loop中有同步和异步任务两种。他们的执行逻辑就是遇到异步先放队列。这似乎就已经可以阐述整个event loop了。

但是实际上，在异步任务的执行中类型中又分了2种任务，就是【微任务】和【宏任务】。而他们的执行顺序有着一个重要的规律——**先执行微任务，再执行宏任务。只要微任务队列中有可执行的任务，就得等可执行的微任务执行完，再执行下一个宏任务。**

# 为什么要分为宏任务和微任务

js机制在对待任务时，认为他们应该是不平等的，也就是说执行更快的任务可以插队，

- 微任务是线程之间的切换，速度快。不用进行上下文切换，可以快速地一次性做完所有的微任务。
- 宏任务是进程之间的切换，速度慢，且每次执行需要切换上下文。
- 微任务执行快，一次性可以执行很多个，在当前宏任务执行后立刻清空微任务可以达到**伪同步**的效果，这对视图渲染效果起到至关重要的作用。

```js
console.log('aaa');

setTimeout(()=>console.log('t1'), 0);
(async ()=>{
  console.log(111);
  await console.log(222);
  console.log(333);
  setTimeout(()=>console.log('t2'), 0);
})().then(()=>{
  console.log(444);
});

console.log('bbb');
// 输出
//aaa
// 111
// 222
// bbb
// 333
// 444
// t1
// t2s
```

上面的例子中，有宏任务t1，t2。微任务333，444。

1. 先同步输出aaa.
2. 遇到宏任务t1,加入队列。
3. 同步输出111，222。
4. 遇到微任务333，加入队列。
5. 遇到宏任务t2，加入队列
6. 遇到微任务444，加入队列
7. 同步输出bbb，同步结束。
8. 回来先执行微任务，输出333，444。微任务结束
9. 执行宏任务，输出t1，t2.

# async/await

这里对于async/await，可能会有朋友有疑惑。其实这里是promise的知识范畴。因为本质他们是Promise的语法糖。因此我们需要了解一个小细节——promise括号内的内容是同步的。then后的才是微任务。

```js
p = new Promise((res,rej)=>{
    console.log(1);
    res('ok');
    console.log(2);
}).then((res)=>{
    console.log(res);
})

console.log(3)
// 输出
// 1
// 2
// 3
// ok
```

同理我们再看看async/await

```js
(async()=>{
 console.log(1);
 await console.log(2);
 console.log('ok')
})()

console.log(3)
// 输出
// 1
// 2
// 3
// ok
```

